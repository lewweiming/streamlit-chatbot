{% extends "_layout_fomantic.html" %}

{% block content %}
<main x-data="main()">
    <h2 class="ui header">Find flight deals around the world</h2>

    <div class="ui three column grid">
        <div class="column">
            {% include 'amadeus/views/flight-booking/_from.html' %}
        </div>
        <div class="column">
            {% include 'amadeus/views/flight-booking/_to.html' %}
        </div>
        <div class="column">
            {% include 'amadeus/views/flight-booking/_book.html' %}
        </div>
    </div>

</main>
{% endblock %}

{% block script %}
<script>
    const API_FETCH_AMADEUS_CITY_SEARCH = '/modules/amadeus/api/flights/city_search.php'
    const API_FETCH_AMADEUS_FLIGHT_OFFERS = '/modules/amadeus/api/flights/flight_offers_search.php'
    const API_FETCH_AMADEUS_FLIGHT_OFFERS_PRICE = '/modules/amadeus/api/flights/flight_offers_price.php'
    const API_FETCH_AMADEUS_FLIGHT_CREATE_ORDER = '/modules/amadeus/api/flights/flight_create_order.php'

    const travelers = [{
            "id": "1",
            "dateOfBirth": "1982-01-16",
            "name": {
              "firstName": name.first,
              "lastName": name.last
            },
            "gender": "MALE",
            "contact": {
              "emailAddress": "jorge.gonzales833@telefonica.es",
              "phones": [{
                "deviceType": "MOBILE",
                "countryCallingCode": "34",
                "number": "480080076"
              }]
            },
            "documents": [{
              "documentType": "PASSPORT",
              "birthPlace": "Madrid",
              "issuanceLocation": "Madrid",
              "issuanceDate": "2015-04-14",
              "number": "00000000",
              "expiryDate": "2025-04-14",
              "issuanceCountry": "ES",
              "validityCountry": "ES",
              "nationality": "ES",
              "holder": true
            }]
          }]

    document.addEventListener('alpine:init', () => {

        Alpine.data('main', () => ({
            date: '', // Departure date, used in flight offers search
            flights: [], // Flight offers
            selectedFlight: null, // The selected flight offer
            firstName: '', // Traveller info
            lastName: '', // Traveller info
            from: 'London', // The input "from"
            origin: '', // The selected "from" location
            fromLocation: [
                // Add your sample location data here
                // {
                //     name: 'Heathrow Airport',
                //     address: {
                //         cityName: 'London',
                //         countryName: 'United Kingdom'
                //     },
                //     subType: 'Airport'
                // },
                // You can add more locations here
            ], // The list of locations generated by the city search api
            to: 'New York', // The input "to"
            destination: '', // The selected "to" location
            toLocation: [], // The list of locations generated by the city search api
            async handleFromLocation() {
                // Add your logic to handle keypress event here
                $.toast({ message: 'Searching "From"' });

                let fd = new FormData();
                fd.append('keywords', this.from);
                let r = await axios.post(API_FETCH_AMADEUS_CITY_SEARCH, fd)

                if (r.data.message == 'success') {
                    $.toast({ class: 'success', message: `Found ${r.data.results.data.length} row(s)` });
                    this.fromLocation = r.data.results.data;
                }
            },
            handleOrigin(location) {
                // Add your logic to handle the click event here
                this.origin = location;
                // this.fromLocationTemplate = false;
                // this.toLocationTemplate = true;
                this.fromLocation = [];
            },
            async handleToLocation() {
                // Add your logic to handle keypress event here
                $.toast({ message: 'Searching "To"' });

                let fd = new FormData();
                fd.append('keywords', this.to);
                let r = await axios.post(API_FETCH_AMADEUS_CITY_SEARCH, fd)

                if (r.data.message == 'success') {
                    $.toast({ class: 'success', message: `Found ${r.data.results.data.length} row(s)` });
                    this.toLocation = r.data.results.data;
                }
            },
            handleDestination(location) {
                // Add your logic to handle the click event here
                this.destination = location;
                // this.fromLocationTemplate = false;
                // this.toLocationTemplate = true;
                this.toLocation = [];
            },
            async searchFlights() {

                // Add your logic to handle keypress event here
                $.toast({ message: 'Searching Flights...' });

                let fd = new FormData();
                fd.append('originLocationCode', this.origin.iataCode);
                fd.append('destinationLocationCode', this.destination.iataCode);
                fd.append('departureDate', this.date);
                fd.append('adults', 1);
                fd.append('max', 5);
                let r = await axios.post(API_FETCH_AMADEUS_FLIGHT_OFFERS, fd)

                if (r.data.message == 'success') {

                    $.toast({ class: 'success', message: `Found ${r.data.results.data.length} row(s)` });
                    this.flights = r.data.results.data;
                }
            },
            // Ensures the pricing is the same when the user confirms the booking
            async confirmFlight(flight) {

                $.toast({ message: 'Checking flight pricing..' });

                let fd = new FormData()
                fd.append('flightOffer', JSON.stringify(flight))

                let r = await axios.post(API_FETCH_AMADEUS_FLIGHT_OFFERS_PRICE, fd)

                if (r.data.message == 'success') {
                    $.toast({ class: 'success', message: `Success` });
                    // this.resultsJson = JSON.stringify(r.data, null, 2);
                    // this.resultsFlightOffers = JSON.stringify(r.data.results.data.flightOffers, null, 2);
                    // $.toast({ class: 'success', message: `Data fetched` });

                    return true;
                }

                return false;
            },
            async onBookFlight(flight) {
                let confirm = await this.confirmFlight(flight)

                if(!confirm) {
                    $.toast({ class: 'error', message: `Error. Flight pricing changed!` });
                    return;
                }

                let flightOffer = JSON.stringify(flight);

                let fd = new FormData()
                fd.append('flightOffers', `[${flightOffer}]`)
                fd.append('travellers', travelers)

                let r = await axios.post(API_FETCH_AMADEUS_FLIGHT_CREATE_ORDER, fd)

                if (r.data.message == 'success') {

                    // this.resultsJson = JSON.stringify(r.data, null, 2);
                    $.toast({ class: 'success', message: `Flight booking complete!` });
                }

            }
        }))
    })

</script>
{% endblock %}